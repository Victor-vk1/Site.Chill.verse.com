<script>
const mainSiteURL = "https://sites.google.com/view/chillverse30-com/home";
const loginBtn = document.getElementById("loginBtn");
const errorMsg = document.getElementById("errorMsg");
const successMsg = document.getElementById("successMsg");

const greetingText = document.getElementById("greetingText");
const hour = new Date().getHours();
if(hour < 12) greetingText.textContent = "Good Morning!";
else if(hour < 18) greetingText.textContent = "Good Afternoon!";
else greetingText.textContent = "Good Evening!";

// Collapsible
const collapsible = document.getElementById("collapsibleMenu");
const menuContent = document.getElementById("menuContent");
collapsible.onclick = ()=> menuContent.style.display = menuContent.style.display==="flex"?"none":"flex";

// Menu Buttons
const setPassBtn = document.getElementById("setPassBtn");
const changePassBtn = document.getElementById("changePassBtn");

const maxAttempts = 3;

// SESSION CHECK
window.onload = ()=>{
  const session = JSON.parse(sessionStorage.getItem("session"));
  const username = sessionStorage.getItem("username");

  // Hide Set Password button if password already exists
  if(username){
    const stored = JSON.parse(localStorage.getItem(username));
    if(stored && stored.password){
      setPassBtn.style.display = "none";
    }
  }

  // Session valid?
  if(session && session.expireTime > Date.now()){
    window.location.href = mainSiteURL;
  } else {
    sessionStorage.removeItem("session");
  }
};

// LOGIN
loginBtn.addEventListener("click", ()=>{
  const username = document.getElementById("usernameInput").value.trim();
  const password = document.getElementById("passwordInput").value.trim();

  if(!username || !password){
    showError("Enter username & password");
    return;
  }

  let stored = JSON.parse(localStorage.getItem(username)) || {password:null, attempts:0};

  // Save username for later (needed for hiding buttons)
  sessionStorage.setItem("username", username);

  // First-time password: create account
  if(!stored.password){
    stored.password = password;
    stored.attempts = 0;
    localStorage.setItem(username, JSON.stringify(stored));

    // Hide Set Password button FOREVER for this username
    setPassBtn.style.display = "none";

    startSession(username);
  }

  // Existing user: verify password
  else {
    if(password === stored.password){
      stored.attempts = 0;
      localStorage.setItem(username, JSON.stringify(stored));

      setPassBtn.style.display = "none"; // ensure hidden

      startSession(username);
    } else {
      stored.attempts++;
      localStorage.setItem(username, JSON.stringify(stored));

      if(stored.attempts >= maxAttempts){
        showError("Too many attempts. Contact admin.");
      } else {
        showError("Incorrect password");
      }
    }
  }
});

// SET PASSWORD (only shows IF no password exists)
setPassBtn.onclick = ()=>{
  const username = document.getElementById("usernameInput").value.trim();
  if(!username){
    showError("Enter username first");
    return;
  }
  const newPass = prompt("Set your new password:");
  if(newPass){
    const stored = JSON.parse(localStorage.getItem(username)) || {attempts:0};
    stored.password = newPass;
    stored.attempts = 0;
    localStorage.setItem(username, JSON.stringify(stored));

    setPassBtn.style.display = "none"; // permanently hide
    showSuccess("Password set successfully");
  }
};

// CHANGE PASSWORD (requires old password)
changePassBtn.onclick = ()=>{
  const username = document.getElementById("usernameInput").value.trim();
  if(!username){
    showError("Enter username first");
    return;
  }

  const stored = JSON.parse(localStorage.getItem(username));
  if(!stored || !stored.password){
    showError("No password set yet.");
    return;
  }

  const oldPass = prompt("Enter OLD password:");
  if(oldPass !== stored.password){
    showError("Incorrect old password");
    return;
  }

  const newPass = prompt("Enter NEW password:");
  if(!newPass){
    showError("Password not changed");
    return;
  }

  stored.password = newPass;
  stored.attempts = 0;
  localStorage.setItem(username, JSON.stringify(stored));

  showSuccess("Password changed successfully");
};

// FUNCTIONS
function startSession(username){
  const expireTime = Date.now()+60*60*1000; // 1 hour
  sessionStorage.setItem("session", JSON.stringify({username, expireTime}));
  window.location.href = mainSiteURL;
}
function showError(msg){
  errorMsg.textContent = msg;
  errorMsg.style.display="block";
  setTimeout(()=>{errorMsg.style.display="none";},2000);
}
function showSuccess(msg){
  successMsg.textContent = msg;
  successMsg.style.display="block";
  setTimeout(()=>{successMsg.style.display="none";},2000);
}

// Reset inactivity timer
function resetTimer(){
  const session = JSON.parse(sessionStorage.getItem("session"));
  if(session){
    session.expireTime = Date.now() + 60*60*1000;
    sessionStorage.setItem("session", JSON.stringify(session));
  }
}
document.addEventListener("mousemove", resetTimer);
document.addEventListener("keydown", resetTimer);
</script>

